<mat-accordion multi="true">
    <mat-expansion-panel #invoicePanel *ngFor="let invoice of invoices"
        (mouseenter)="showActions(editBtn, paymentReceivedBtn, payoutSentBtn)"
        (mouseleave)="hideActions(editBtn, paymentReceivedBtn, payoutSentBtn)">
        <mat-expansion-panel-header>
            <mat-panel-title class="invoice-title">
                <span>{{invoice.propertyName}}</span>
            </mat-panel-title>
            <mat-panel-description class="invoice-description d-none d-sm-block">
                <span class="pe-5">{{ 'invoice_list.from' | translate }}: {{invoice.payer}}</span>
                <span class="pe-5">{{invoice.amount}}</span>
                <span class="pe-5">{{ 'invoice_list.period' | translate }}: {{invoice.paymentWindow}}</span>
            </mat-panel-description>
            <div style="display: none" #editBtn>
                <button *ngIf="canEditInvoices && !invoicesBeingEdited.includes(invoice.id!)" mat-button
                    (click)="$event.stopPropagation(); editInvoice(invoicePanel, invoice);"
                    [matTooltip]="'invoice_list.edit_invoice' | translate">
                    <mat-icon>edit</mat-icon>
                </button>
            </div>
            <div style="display: none" #paymentReceivedBtn>
                <button *ngIf="canEditInvoices 
                    && invoice.status === 'unpaid' 
                    && !invoicesBeingEdited.includes(invoice.id!)" mat-button
                    [matTooltip]="'invoice_list.payment_received' | translate"
                    (click)="$event.stopPropagation(); invoicePaymentReceived(invoice)">
                    <mat-icon color="accent">check</mat-icon>
                </button>
            </div>
            <div style="display: none" #payoutSentBtn>
                <button *ngIf="canEditInvoices 
                    && invoice.status === 'paid'
                    && !invoicesBeingEdited.includes(invoice.id!)" mat-button
                    [matTooltip]="'invoice_list.paid_out' | translate"
                    (click)="$event.stopPropagation(); invoicePaidOut(invoice)">
                    <mat-icon color="accent">check</mat-icon>
                </button>
            </div>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
            <ng-container *ngIf="!invoicesBeingEdited.includes(invoice.id!)" [ngTemplateOutlet]="invoiceDetails"
                [ngTemplateOutletContext]="{invoice: invoice}">
            </ng-container>
            <ng-container *ngIf="invoicesBeingEdited.includes(invoice.id!)" [ngTemplateOutlet]="invoiceEdit"
                [ngTemplateOutletContext]="{invoice: invoice}">
            </ng-container>

            <div *ngIf="invoicesBeingEdited.includes(invoice.id!)" class="d-flex justify-content-end">
                <button mat-button (click)="cancelEdit(invoice)">
                    <mat-icon>clear</mat-icon>
                </button>
                <button mat-button (click)="saveEdit(invoice)">
                    <mat-icon color="accent">save</mat-icon>
                </button>
            </div>
        </ng-template>
    </mat-expansion-panel>
</mat-accordion>

<ng-template #invoiceDetails let-invoice="invoice">
    <div class="row d-flex justify-content-between">
        <label-span class="col-12" [label]="'invoice_list.description' | translate" [span]="invoice.description!">
        </label-span>
    </div>
    <div class="row pt-2">
        <label-span class="col-4" [label]="'invoice_list.payer' | translate" [span]="invoice.payer!">
        </label-span>
        <label-span class="col-4" [label]="'invoice_list.payee' | translate" [span]="invoice.payee!">
        </label-span>
    </div>
    <div class="row pt-2">
        <label-span class="col-4" [label]="'invoice_list.begin_date' | translate"
            [span]="invoice.beginDate!.toDate() | date: 'dd/MM/yyyy'">
        </label-span>
        <label-span class="col-4" [label]="'invoice_list.due_date' | translate"
            [span]="invoice.dueDate!.toDate() | date: 'dd/MM/yyyy'">
        </label-span>
        <label-span *ngIf="invoice.payoutDate" class="col-4" [label]="'invoice_list.payout_date' | translate"
            [span]="invoice.payoutDate!.toDate() | date: 'dd/MM/yyyy'">
        </label-span>
    </div>
</ng-template>

<ng-template #invoiceEdit let-invoice="invoice">
    <div class="row">
        <mat-form-field class="col-12">
            <mat-label>{{ 'invoice_list.description' | translate }}</mat-label>
            <input matInput type="text" [(ngModel)]="invoice.description">
        </mat-form-field>
    </div>
    <div class="row pt-2">
        <mat-form-field class="col-4">
            <mat-label>{{ 'invoice_list.payer' | translate }}</mat-label>
            <input matInput type="text" [(ngModel)]="invoice.payer">
        </mat-form-field>
        <mat-form-field class="col-4">
            <mat-label>{{ 'invoice_list.payee' | translate }}</mat-label>
            <input matInput type="text" [(ngModel)]="invoice.payee">
        </mat-form-field>
    </div>
    <div class="row pt-2">
        <mat-form-field class="col-4">
            <mat-label>{{ 'invoice_list.begin_date' | translate }}</mat-label>
            <input readonly matInput [matDatepicker]="beginDatePicker" type="text"
                [ngModel]="invoice.beginDate.toDate() | date: 'yyyy-MM-dd'" (click)="beginDatePicker.open()">
            <mat-datepicker-toggle matSuffix [for]="beginDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #beginDatePicker></mat-datepicker>
        </mat-form-field>
        <mat-form-field class="col-4">
            <mat-label>{{ 'invoice_list.due_date' | translate }}</mat-label>
            <input readonly matInput type="text" [matDatepicker]="dueDatePicker"
                [ngModel]="invoice.dueDate.toDate() | date: 'yyyy-MM-dd'" (click)="dueDatePicker.open()">
            <mat-datepicker-toggle matSuffix [for]="dueDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #dueDatePicker></mat-datepicker>
        </mat-form-field>
        <mat-form-field *ngIf="invoice.payoutDate" class="col-4">
            <mat-label>{{ 'invoice_list.payout_date' | translate }}</mat-label>
            <input readonly matInput type="text" [matDatepicker]="payoutDatePicker"
                [ngModel]="invoice.dueDate.toDate() | date: 'yyyy-MM-dd'" (click)="payoutDatePicker.open()">
            <mat-datepicker-toggle matSuffix [for]="payoutDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #payoutDatePicker></mat-datepicker>
        </mat-form-field>
    </div>
</ng-template>